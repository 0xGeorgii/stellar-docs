---
title: Get changes from a ledger range
sidebar_position: 30
---

This code connects to a Stellar history archive using a `ledgerbackend.CaptiveCoreConfig` and retrieves ledger data between a specified range of ledger sequences. It uses the `ingest.LedgerChangeReader` to read changes from each ledger (`xdr.LedgerCloseMeta`) and categorizes the changes based on whether they represent created, updated, or deleted ledger entries. The `ingest.Change` structure is used to capture individual changes, and the code tracks various types of changes such as those related to fees, transactions, or operations.

<CodeExample>

```go
// Filename: change_entries.go

package main

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/stellar/go/ingest"
	"github.com/stellar/go/ingest/ledgerbackend"
	"github.com/stellar/go/network"
	"github.com/stellar/go/xdr"
	"io"
)

var (
	config = captiveCoreConfig()
)

func captiveCoreConfig() ledgerbackend.CaptiveCoreConfig {
	archiveURLs := network.TestNetworkhistoryArchiveURLs
	networkPassphrase := network.TestNetworkPassphrase
	captiveCoreToml, err := ledgerbackend.NewCaptiveCoreToml(ledgerbackend.CaptiveCoreTomlParams{
		NetworkPassphrase:  networkPassphrase,
		HistoryArchiveURLs: archiveURLs,
	})
	panicIf(err)

	return ledgerbackend.CaptiveCoreConfig{
		// Change these based on your environment:
		BinaryPath:         "/usr/local/bin/stellar-core",
		NetworkPassphrase:  networkPassphrase,
		HistoryArchiveURLs: archiveURLs,
		Toml:               captiveCoreToml,
	}
}

func panicIf(err error) {
	if err != nil {
		panic(fmt.Errorf("An error occurred, panicking: %s\n", err))
	}
}

func getChangesFromLedger(passphrase string, ledger xdr.LedgerCloseMeta) []ingest.Change {
	changeReader, err := ingest.NewLedgerChangeReaderFromLedgerCloseMeta(passphrase, ledger)
	changes := make([]ingest.Change, 0)
	defer changeReader.Close()
	panicIf(err)
	for {
		change, err := changeReader.Read()
		if err == io.EOF {
			break
		}
		panicIf(err)
		changes = append(changes, change)
	}
	return changes
}

func getLedgers(startingLedger uint32, endLedger uint32) map[uint32]xdr.LedgerCloseMeta {
	captiveCore, err := ledgerbackend.NewCaptive(config)
	panicIf(err)

	ctx := context.Background()
	err = captiveCore.PrepareRange(ctx, ledgerbackend.BoundedRange(startingLedger, endLedger))
	panicIf(err)

	var seqToLedgersMap = make(map[uint32]xdr.LedgerCloseMeta)
	for ledgerSeq := startingLedger; ledgerSeq <= endLedger; ledgerSeq++ {
		ledger, err := captiveCore.GetLedger(ctx, ledgerSeq)
		panicIf(err)
		seqToLedgersMap[ledgerSeq] = ledger
	}

	err = captiveCore.Close()
	panicIf(err)
	return seqToLedgersMap
}

type ChangesInfo struct {
	LedgerEntriesCreated    int32
	LedgerEntriesUpdated    int32
	LedgerEntriesDeleted    int32
	FeeRelatedChanges       int32
	TxRelatedChanges        int32
	OperationRelatedChanges int32
}

func changeCausedBy(change ingest.Change) xdr.LedgerEntryChangeType {
	if change.Pre == nil && change.Post != nil {
		return xdr.LedgerEntryChangeTypeLedgerEntryCreated
	} else if change.Pre != nil && change.Post == nil {
		return xdr.LedgerEntryChangeTypeLedgerEntryRemoved
	} else if change.Pre != nil && change.Post != nil {
		return xdr.LedgerEntryChangeTypeLedgerEntryUpdated
	}
	// this should not happen
	return xdr.LedgerEntryChangeType(-1)

}

func main() {
	startingLedger := uint32(123622) // Replace with your desired ledger number
	endLedger := startingLedger + 5

	// Get the ledger metadata
	ledgers := getLedgers(startingLedger, endLedger)

	for seq, ledgerMeta := range ledgers {
		fmt.Printf("Processing ledger: %d\n", seq)
		changes := getChangesFromLedger(config.NetworkPassphrase, ledgerMeta)
		info := ChangesInfo{}
		for _, change := range changes {

			/* Uncomment this code to print the change struct
			jsonData, err := json.MarshalIndent(change, "", "  ")
			panicIf(err)
			fmt.Println(string(jsonData))
			*/

			switch changeCausedBy(change) {
			case xdr.LedgerEntryChangeTypeLedgerEntryCreated:
				info.LedgerEntriesCreated++
			case xdr.LedgerEntryChangeTypeLedgerEntryRemoved:
				info.LedgerEntriesDeleted++
			case xdr.LedgerEntryChangeTypeLedgerEntryUpdated:
				info.LedgerEntriesUpdated++
			}

			switch change.Reason {
			case ingest.LedgerEntryChangeReasonFee:
				info.FeeRelatedChanges++
			case ingest.LedgerEntryChangeReasonTransaction:
				info.TxRelatedChanges++
			case ingest.LedgerEntryChangeReasonOperation:
				info.OperationRelatedChanges++
			default:
			}

		}

		fmt.Printf("Finished parsing changes from ledger: %d\n", seq)
		jsonData, err := json.MarshalIndent(info, "", "  ")
		panicIf(err)
		fmt.Println(string(jsonData))
	}
}
```

</CodeExample>

**Sample Response:**

```bash
>> go run ./change_entries.go

// Log lines truncated for clarity

Processing ledger: 123622
Finished parsing changes from ledger: 123622
{
  "LedgerEntriesCreated": 1,
  "LedgerEntriesUpdated": 13,
  "LedgerEntriesDeleted": 0,
  "FeeRelatedChanges": 5,
  "TxRelatedChanges": 5,
  "OperationRelatedChanges": 4
}
Processing ledger: 123623
Finished parsing changes from ledger: 123623
{
  "LedgerEntriesCreated": 1,
  "LedgerEntriesUpdated": 10,
  "LedgerEntriesDeleted": 1,
  "FeeRelatedChanges": 4,
  "TxRelatedChanges": 4,
  "OperationRelatedChanges": 4
}
Processing ledger: 123624
Finished parsing changes from ledger: 123624
{
  "LedgerEntriesCreated": 1,
  "LedgerEntriesUpdated": 12,
  "LedgerEntriesDeleted": 0,
  "FeeRelatedChanges": 5,
  "TxRelatedChanges": 5,
  "OperationRelatedChanges": 3
}
Processing ledger: 123625
Finished parsing changes from ledger: 123625
{
  "LedgerEntriesCreated": 3,
  "LedgerEntriesUpdated": 12,
  "LedgerEntriesDeleted": 0,
  "FeeRelatedChanges": 4,
  "TxRelatedChanges": 4,
  "OperationRelatedChanges": 7
}
Processing ledger: 123626
Finished parsing changes from ledger: 123626
{
  "LedgerEntriesCreated": 4,
  "LedgerEntriesUpdated": 15,
  "LedgerEntriesDeleted": 0,
  "FeeRelatedChanges": 5,
  "TxRelatedChanges": 5,
  "OperationRelatedChanges": 9
}
Processing ledger: 123627
Finished parsing changes from ledger: 123627
{
  "LedgerEntriesCreated": 1,
  "LedgerEntriesUpdated": 5,
  "LedgerEntriesDeleted": 0,
  "FeeRelatedChanges": 2,
  "TxRelatedChanges": 2,
  "OperationRelatedChanges": 2
}
```
